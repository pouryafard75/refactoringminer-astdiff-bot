<head><meta charset="utf8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link type="text/css" href="../resources/dist/single.css" rel="stylesheet"/><link type="text/css" href="../resources/dist/monaco.css" rel="stylesheet"/><script type="text/javascript" src="../resources/dist/utils.js"></script><script type="text/javascript" src="../resources/dist/folding.js"></script><script type="text/javascript" src="../resources/dist/decorations.js"></script><script type="text/javascript" src="../resources/dist/monaco.js"></script><script type="text/javascript" src="../resources/monaco/min/vs/loader.js"></script></head><!DOCTYPE html><html lang="en"><body><div class="container-fluid" style="padding-left: 0"><div class="row h-100"><div class="col-2 bg-light dir-diff"><!DOCTYPE html><html lang="en"><head><meta charset="utf8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>RefactoringMiner</title><link type="text/css" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/><script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script><script type="text/javascript" src="../resources/dist/shortcuts.js"></script><link type="text/css" href="../resources/dist/style.css" rel="stylesheet"/></head><body><div class="container-fluid" style="padding: 0;"><div class="row"><div class="col"><div class="btn-toolbar justify-content-end"><div class="btn-group" style="padding: 5px;"><a class="btn btn-default btn-sm btn-danger" href="../list">Back</a></div></div></div></div><div class="row mt-3 mb-3"><div class="col"><div class="card" style="padding: 5px"><div class="card-header"><h4 class="card-title mb-0">Modified files <span class="badge badge-secondary" style="color:black">1</span></h4></div><div class="tree-root"><ul><li><details open="true"><summary>servers/src/main/java/tachyon/worker/block/allocator</summary><ul><table class="table card-table table-striped table-condensed mb-0"><tbody><tr><td style="white-space: normal; word-wrap: break-word; word-break: break-all;"><a id="diff_row_0" href="../monaco-page/0"><img src="../resources/dist/icons8-file-edit.svg" width=15 height=17 title="modified file"/> MaxFreeAllocator.java</a></td></tr></tbody></table></ul></details></li></ul></div></div></div></div></div></body></html></div><div class="col-10 monaco-panel"><div id="accordion"><div class="card"><div class="card-header" id="heading-0" style="padding-right: 0;"><div class="d-flex align-items-center justify-content-between"><div class="flex-grow-1" style="word-break: break-word; overflow-wrap: anywhere;"><h5 class="mb-0"><a class="" data-bs-toggle="collapse" data-bs-target="#collapse-0" aria-expanded="true" aria-controls="collapse-0">servers/src/main/java/tachyon/worker/block/allocator/MaxFreeAllocator.java -&gt; servers/src/main/java/tachyon/worker/block/allocator/MaxFreeAllocator.java</a></h5></div><div class="text-end"><a href="../monaco-page/0" class="btn btn-primary btn sm">Details</a></div></div></div><div id="collapse-0" class="collapse show" aria-labelledby="heading-0"><div class="card-body" style="overflow: hidden; padding: 0;"><div class="row h-100"><div class="col-6 h-100"><div class="edc" id="left-container-0" style="border: 1px solid grey; overflow: auto;"></div></div><div class="col-6"><div class="edc" id="right-container-0" style="border: 1px solid grey; overflow: auto;"></div></div><script type="text/javascript">/*<![CDATA[*/mymonaco({ moved: false, id: 0, spv: true, file: "servers/src/main/java/tachyon/worker/block/allocator/MaxFreeAllocator.java", left: {url:"/left/0",content:"/*\n * Licensed to the University of California, Berkeley under one or more contributor license\n * agreements. See the NOTICE file distributed with this work for additional information regarding\n * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n * copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\npackage tachyon.worker.block.allocator;\n\nimport java.io.IOException;\n\nimport com.google.common.base.Preconditions;\n\nimport tachyon.worker.block.BlockStoreLocation;\nimport tachyon.worker.block.BlockMetadataManager;\nimport tachyon.worker.block.meta.StorageDir;\nimport tachyon.worker.block.meta.StorageTier;\nimport tachyon.worker.block.meta.TempBlockMeta;\n\n/**\n * An allocator that allocates a block in the storage dir with most free space.\n */\npublic class MaxFreeAllocator implements Allocator {\n  private final BlockMetadataManager mMetaManager;\n\n  public MaxFreeAllocator(BlockMetadataManager metadata) {\n    mMetaManager = Preconditions.checkNotNull(metadata);\n  }\n\n  @Override\n  public TempBlockMeta allocateBlock(long userId, long blockId, long blockSize,\n      BlockStoreLocation location) throws IOException {\n\n    StorageDir candidateDir = null;\n    long maxFreeBytes = blockSize;\n\n    if (location.equals(BlockStoreLocation.anyTier())) {\n      for (StorageTier tier : mMetaManager.getTiers()) {\n        for (StorageDir dir : tier.getStorageDirs()) {\n          if (dir.getAvailableBytes() >= maxFreeBytes) {\n            maxFreeBytes = dir.getAvailableBytes();\n            candidateDir = dir;\n          }\n        }\n      }\n    } else if (location.equals(BlockStoreLocation.anyDirInTier(location.tierAlias()))) {\n      StorageTier tier = mMetaManager.getTier(location.tierAlias());\n      for (StorageDir dir : tier.getStorageDirs()) {\n        if (dir.getAvailableBytes() >= maxFreeBytes) {\n          maxFreeBytes = dir.getAvailableBytes();\n          candidateDir = dir;\n        }\n      }\n    } else {\n      StorageTier tier = mMetaManager.getTier(location.tierAlias());\n      StorageDir dir = tier.getDir(location.dir());\n      if (dir.getAvailableBytes() >= blockSize) {\n        candidateDir = dir;\n      }\n    }\n\n    return candidateDir != null ? new TempBlockMeta(userId, blockId, blockSize, candidateDir)\n        : null;\n  }\n}\n",ranges: [{from: 1154,to: 1230,index: 4,kind: "updated",tooltip: "TagElement/TextElement/1154/1230",},{from: 1650,to: 1680,index: 4,kind: "moved",tooltip: "Block/VariableDeclarationStatement/1650/1680",},{from: 1670,to: 1679,index: 6,kind: "moved",tooltip: "VariableDeclarationFragment/SimpleName/1670/1679",},{from: 1804,to: 2013,index: 8,kind: "mm",tooltip: "Block/EnhancedForStatement/1804/2013",},{from: 1889,to: 1891,index: 12,kind: "mm updOnTop",tooltip: "InfixExpression/INFIX_EXPRESSION_OPERATOR/1889/1891",},{from: 2186,to: 2385,index: 7,kind: "mm",tooltip: "Block/EnhancedForStatement/2186/2385",},{from: 2269,to: 2271,index: 11,kind: "mm updOnTop",tooltip: "InfixExpression/INFIX_EXPRESSION_OPERATOR/2269/2271",},],}, lcid: "left-container-0", right: {url:"/right/0",content:"/*\n * Licensed to the University of California, Berkeley under one or more contributor license\n * agreements. See the NOTICE file distributed with this work for additional information regarding\n * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n * copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\npackage tachyon.worker.block.allocator;\n\nimport java.io.IOException;\n\nimport com.google.common.base.Preconditions;\n\nimport tachyon.worker.block.BlockStoreLocation;\nimport tachyon.worker.block.BlockMetadataManager;\nimport tachyon.worker.block.meta.StorageDir;\nimport tachyon.worker.block.meta.StorageTier;\nimport tachyon.worker.block.meta.TempBlockMeta;\n\n/**\n * An allocator that allocates a block in the storage dir with most free space. It always allocates\n * to the highest tier if the requested block store location is any tier.\n */\npublic class MaxFreeAllocator implements Allocator {\n  private final BlockMetadataManager mMetaManager;\n\n  public MaxFreeAllocator(BlockMetadataManager metadata) {\n    mMetaManager = Preconditions.checkNotNull(metadata);\n  }\n\n  @Override\n  public TempBlockMeta allocateBlock(long userId, long blockId, long blockSize,\n      BlockStoreLocation location) throws IOException {\n    StorageDir candidateDir = null;\n\n    if (location.equals(BlockStoreLocation.anyTier())) {\n      for (StorageTier tier : mMetaManager.getTiers()) {\n        candidateDir = getCandidateDirInTier(tier, blockSize);\n        if (candidateDir != null) {\n          return new TempBlockMeta(userId, blockId, blockSize, candidateDir);\n        }\n      }\n    } else if (location.equals(BlockStoreLocation.anyDirInTier(location.tierAlias()))) {\n      StorageTier tier = mMetaManager.getTier(location.tierAlias());\n      candidateDir = getCandidateDirInTier(tier, blockSize);\n    } else {\n      StorageTier tier = mMetaManager.getTier(location.tierAlias());\n      StorageDir dir = tier.getDir(location.dir());\n      if (dir.getAvailableBytes() >= blockSize) {\n        candidateDir = dir;\n      }\n    }\n\n    return candidateDir != null ? new TempBlockMeta(userId, blockId, blockSize, candidateDir)\n        : null;\n  }\n\n  /**\n   * Find a directory in a tier that has max free space and is able to store the block.\n   *\n   * @param tier the storage tier\n   * @param blockSize the size of block in bytes\n   * @return the storage directory if found, null otherwise\n   */\n  private StorageDir getCandidateDirInTier(StorageTier tier, long blockSize) {\n    StorageDir candidateDir = null;\n    long maxFreeBytes = blockSize - 1;\n    for (StorageDir dir : tier.getStorageDirs()) {\n      if (dir.getAvailableBytes() > maxFreeBytes) {\n        maxFreeBytes = dir.getAvailableBytes();\n        candidateDir = dir;\n      }\n    }\n    return candidateDir;\n  }\n}\n",ranges: [{from: 1154,to: 1250,index: 4,kind: "updated",tooltip: "TagElement/TextElement/1154/1250",},{from: 1254,to: 1324,index: 4,kind: "inserted",tooltip: "TagElement/TextElement/1254/1324",},{from: 1862,to: 1916,index: 8,kind: "inserted",tooltip: "Block/ExpressionStatement/1862/1916",},{from: 1925,to: 2040,index: 8,kind: "inserted",tooltip: "Block/IfStatement/1925/2040",},{from: 2213,to: 2267,index: 7,kind: "inserted",tooltip: "Block/ExpressionStatement/2213/2267",},{from: 2612,to: 3233,index: 2,kind: "inserted",tooltip: "TypeDeclaration/MethodDeclaration/2612/3233",},{from: 2612,to: 2857,index: 3,kind: "inserted",tooltip: "MethodDeclaration/Javadoc/2612/2857",},{from: 2868,to: 2878,index: 3,kind: "inserted",tooltip: "MethodDeclaration/SimpleType/2868/2878",},{from: 2901,to: 2917,index: 3,kind: "inserted",tooltip: "MethodDeclaration/SingleVariableDeclaration/2901/2917",},{from: 2919,to: 2933,index: 3,kind: "inserted",tooltip: "MethodDeclaration/SingleVariableDeclaration/2919/2933",},{from: 2935,to: 3233,index: 3,kind: "inserted",tooltip: "MethodDeclaration/Block/2935/3233",},{from: 2941,to: 2972,index: 4,kind: "inserted",tooltip: "Block/VariableDeclarationStatement/2941/2972",},{from: 2977,to: 3011,index: 4,kind: "moved",tooltip: "Block/VariableDeclarationStatement/2977/3011",},{from: 2997,to: 3010,index: 6,kind: "inserted",tooltip: "VariableDeclarationFragment/InfixExpression/2997/3010",},{from: 2997,to: 3006,index: 7,kind: "moved",tooltip: "InfixExpression/SimpleName/2997/3006",},{from: 3016,to: 3204,index: 4,kind: "mm",tooltip: "Block/EnhancedForStatement/3016/3204",},{from: 3097,to: 3098,index: 8,kind: "mm updOnTop",tooltip: "InfixExpression/INFIX_EXPRESSION_OPERATOR/3097/3098",},{from: 3209,to: 3229,index: 4,kind: "inserted",tooltip: "Block/ReturnStatement/3209/3229",},],}, rcid: "right-container-0", mappings: [[0, 2729, 0, 3236], [0, 791, 0, 791], [793, 832, 793, 832], [801, 831, 801, 831], [834, 861, 834, 861], [841, 860, 841, 860], [863, 907, 863, 907], [870, 906, 870, 906], [909, 956, 909, 956], [916, 955, 916, 955], [957, 1006, 957, 1006], [964, 1005, 964, 1005], [1007, 1051, 1007, 1051], [1014, 1050, 1014, 1050], [1052, 1097, 1052, 1097], [1059, 1096, 1059, 1096], [1098, 1145, 1098, 1145], [1105, 1144, 1105, 1144], [1147, 2728, 1147, 3235], [1147, 1234, 1147, 1328], [1154, 1230, 1154, 1324], [1154, 1230, 1154, 1250], [1235, 1241, 1329, 1335], [1242, 1247, 1336, 1341], [1248, 1264, 1342, 1358], [1276, 1285, 1370, 1379], [1276, 1285, 1370, 1379], [1290, 1338, 1384, 1432], [1290, 1297, 1384, 1391], [1298, 1303, 1392, 1397], [1304, 1324, 1398, 1418], [1304, 1324, 1398, 1418], [1325, 1337, 1419, 1431], [1325, 1337, 1419, 1431], [1342, 1459, 1436, 1553], [1342, 1348, 1436, 1442], [1349, 1365, 1443, 1459], [1366, 1395, 1460, 1489], [1366, 1386, 1460, 1480], [1366, 1386, 1460, 1480], [1387, 1395, 1481, 1489], [1397, 1459, 1491, 1553], [1403, 1455, 1497, 1549], [1403, 1454, 1497, 1548], [1403, 1415, 1497, 1509], [1416, 1417, 1510, 1511], [1418, 1454, 1512, 1548], [1418, 1431, 1512, 1525], [1418, 1431, 1512, 1525], [1432, 1444, 1526, 1538], [1445, 1453, 1539, 1547], [1445, 1453, 1539, 1547], [1463, 2726, 1557, 2608], [1463, 1472, 1557, 1566], [1464, 1472, 1558, 1566], [1475, 1481, 1569, 1575], [1482, 1495, 1576, 1589], [1482, 1495, 1576, 1589], [1496, 1509, 1590, 1603], [1510, 1521, 1604, 1615], [1510, 1514, 1604, 1608], [1515, 1521, 1609, 1615], [1523, 1535, 1617, 1629], [1523, 1527, 1617, 1621], [1528, 1535, 1622, 1629], [1537, 1551, 1631, 1645], [1537, 1541, 1631, 1635], [1542, 1551, 1636, 1645], [1559, 1586, 1653, 1680], [1559, 1577, 1653, 1671], [1559, 1577, 1653, 1671], [1578, 1586, 1672, 1680], [1595, 1606, 1689, 1700], [1595, 1606, 1689, 1700], [1607, 2726, 1701, 2608], [1614, 1645, 1707, 1738], [1614, 1624, 1707, 1717], [1614, 1624, 1707, 1717], [1625, 1644, 1718, 1737], [1625, 1637, 1718, 1730], [1640, 1644, 1733, 1737], [1650, 1680, 2977, 3011], [1650, 1654, 2977, 2981], [1655, 1679, 2982, 3010], [1655, 1667, 2982, 2994], [1670, 1679, 2997, 3006], [1686, 2611, 1744, 2493], [1690, 1735, 1748, 1793], [1690, 1698, 1748, 1756], [1690, 1698, 1748, 1756], [1699, 1705, 1757, 1763], [1706, 1734, 1764, 1792], [1706, 1734, 1764, 1792], [1706, 1724, 1764, 1782], [1706, 1724, 1764, 1782], [1725, 1732, 1783, 1790], [1737, 2027, 1795, 2054], [1745, 2021, 1803, 2048], [1750, 1766, 1808, 1824], [1750, 1761, 1808, 1819], [1750, 1761, 1808, 1819], [1762, 1766, 1820, 1824], [1769, 1792, 1827, 1850], [1769, 1781, 1827, 1839], [1769, 1781, 1827, 1839], [1782, 1790, 1840, 1848], [1794, 2021, 1852, 2048], [1804, 2013, 3016, 3204], [1809, 1823, 3021, 3035], [1809, 1819, 3021, 3031], [1809, 1819, 3021, 3031], [1820, 1823, 3032, 3035], [1826, 1847, 3038, 3059], [1826, 1830, 3038, 3042], [1826, 1830, 3038, 3042], [1831, 1845, 3043, 3057], [1849, 2013, 3061, 3204], [1861, 2003, 3069, 3198], [1865, 1904, 3073, 3111], [1865, 1888, 3073, 3096], [1865, 1868, 3073, 3076], [1865, 1868, 3073, 3076], [1869, 1886, 3077, 3094], [1889, 1891, 3097, 3098], [1892, 1904, 3099, 3111], [1906, 2003, 3113, 3198], [1920, 1959, 3123, 3162], [1920, 1958, 3123, 3161], [1920, 1932, 3123, 3135], [1933, 1934, 3136, 3137], [1935, 1958, 3138, 3161], [1935, 1938, 3138, 3141], [1935, 1938, 3138, 3141], [1939, 1956, 3142, 3159], [1972, 1991, 3171, 3190], [1972, 1990, 3171, 3189], [1972, 1984, 3171, 3183], [1985, 1986, 3184, 3185], [1987, 1990, 3186, 3189], [2033, 2611, 2060, 2493], [2037, 2107, 2064, 2134], [2037, 2045, 2064, 2072], [2037, 2045, 2064, 2072], [2046, 2052, 2073, 2079], [2053, 2106, 2080, 2133], [2053, 2106, 2080, 2133], [2053, 2071, 2080, 2098], [2053, 2071, 2080, 2098], [2072, 2084, 2099, 2111], [2085, 2105, 2112, 2132], [2085, 2105, 2112, 2132], [2085, 2093, 2112, 2120], [2085, 2093, 2112, 2120], [2094, 2103, 2121, 2130], [2109, 2391, 2136, 2273], [2117, 2179, 2144, 2206], [2117, 2128, 2144, 2155], [2117, 2128, 2144, 2155], [2129, 2178, 2156, 2205], [2129, 2133, 2156, 2160], [2136, 2178, 2163, 2205], [2136, 2148, 2163, 2175], [2136, 2148, 2163, 2175], [2149, 2156, 2176, 2183], [2157, 2177, 2184, 2204], [2157, 2177, 2184, 2204], [2157, 2165, 2184, 2192], [2157, 2165, 2184, 2192], [2166, 2175, 2193, 2202], [2186, 2385, 3016, 3204], [2191, 2205, 3021, 3035], [2191, 2201, 3021, 3031], [2191, 2201, 3021, 3031], [2202, 2205, 3032, 3035], [2208, 2229, 3038, 3059], [2208, 2212, 3038, 3042], [2208, 2212, 3038, 3042], [2213, 2227, 3043, 3057], [2231, 2385, 3061, 3204], [2241, 2377, 3069, 3198], [2245, 2284, 3073, 3111], [2245, 2268, 3073, 3096], [2245, 2248, 3073, 3076], [2245, 2248, 3073, 3076], [2249, 2266, 3077, 3094], [2269, 2271, 3097, 3098], [2272, 2284, 3099, 3111], [2286, 2377, 3113, 3198], [2298, 2337, 3123, 3162], [2298, 2336, 3123, 3161], [2298, 2310, 3123, 3135], [2311, 2312, 3136, 3137], [2313, 2336, 3138, 3161], [2313, 2316, 3138, 3141], [2313, 2316, 3138, 3141], [2317, 2334, 3142, 3159], [2348, 2367, 3171, 3190], [2348, 2366, 3171, 3189], [2348, 2360, 3171, 3183], [2361, 2362, 3184, 3185], [2363, 2366, 3186, 3189], [2397, 2611, 2279, 2493], [2405, 2467, 2287, 2349], [2405, 2416, 2287, 2298], [2405, 2416, 2287, 2298], [2417, 2466, 2299, 2348], [2417, 2421, 2299, 2303], [2424, 2466, 2306, 2348], [2424, 2436, 2306, 2318], [2424, 2436, 2306, 2318], [2437, 2444, 2319, 2326], [2445, 2465, 2327, 2347], [2445, 2465, 2327, 2347], [2445, 2453, 2327, 2335], [2445, 2453, 2327, 2335], [2454, 2463, 2336, 2345], [2474, 2519, 2356, 2401], [2474, 2484, 2356, 2366], [2474, 2484, 2356, 2366], [2485, 2518, 2367, 2400], [2485, 2488, 2367, 2370], [2491, 2518, 2373, 2400], [2491, 2495, 2373, 2377], [2491, 2495, 2373, 2377], [2496, 2502, 2378, 2384], [2503, 2517, 2385, 2399], [2503, 2517, 2385, 2399], [2503, 2511, 2385, 2393], [2503, 2511, 2385, 2393], [2512, 2515, 2394, 2397], [2526, 2605, 2408, 2487], [2530, 2566, 2412, 2448], [2530, 2553, 2412, 2435], [2530, 2533, 2412, 2415], [2530, 2533, 2412, 2415], [2534, 2551, 2416, 2433], [2554, 2556, 2436, 2438], [2557, 2566, 2439, 2448], [2568, 2605, 2450, 2487], [2578, 2597, 2460, 2479], [2578, 2596, 2460, 2478], [2578, 2590, 2460, 2472], [2591, 2592, 2473, 2474], [2593, 2596, 2475, 2478], [2617, 2722, 2499, 2604], [2624, 2721, 2506, 2603], [2624, 2644, 2506, 2526], [2624, 2636, 2506, 2518], [2637, 2639, 2519, 2521], [2640, 2644, 2522, 2526], [2647, 2706, 2529, 2588], [2651, 2664, 2533, 2546], [2651, 2664, 2533, 2546], [2665, 2671, 2547, 2553], [2673, 2680, 2555, 2562], [2682, 2691, 2564, 2573], [2693, 2705, 2575, 2587], [2717, 2721, 2599, 2603], ],});/*]]>*/</script></div></div></div></div></div></div></div></div><script type="text/javascript" src="../resources/dist/single.js"></script></body></html>